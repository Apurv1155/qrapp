<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bella Vista Kitchen - ULTRA SPEED RECEIVER</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #2C5F2D 0%, #97BC62 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 18px; }
        .header { background: white; border-radius: 15px; padding: 25px; margin-bottom: 22px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); text-align: center; }
        .kitchen-title { font-size: 2.4rem; color: #2C5F2D; margin-bottom: 8px; }
        .kitchen-subtitle { color: #666; font-size: 1.1rem; }
        .ultra-status { background: linear-gradient(45deg, #ff6b6b, #ffd93d); border: 2px solid #ff6b6b; padding: 18px; border-radius: 10px; margin-bottom: 18px; text-align: center; animation: pulse 2s infinite; }
        .status-title { color: #ffffff; font-weight: bold; font-size: 1.3rem; margin-bottom: 8px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .status-subtitle { color: #fff; font-size: 0.9rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .auth-status { background: linear-gradient(45deg, #28a745, #20c997); border: 2px solid #28a745; padding: 15px; border-radius: 10px; margin-bottom: 18px; color: white; text-align: center; }
        .auth-title { font-weight: bold; margin-bottom: 8px; font-size: 1.1rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .auth-subtitle { font-size: 0.85rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .json-removal-info { background: linear-gradient(45deg, #e74c3c, #f39c12); border: 2px solid #e74c3c; padding: 18px; border-radius: 10px; margin-bottom: 18px; color: white; }
        .removal-title { font-weight: bold; margin-bottom: 12px; font-size: 1.1rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .removal-features { list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px; }
        .removal-features li { margin: 4px 0; padding: 6px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 0.85rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .removal-features li:before { content: "üóëÔ∏è "; font-weight: bold; margin-right: 4px; }
        .monitoring-panel { background: white; padding: 18px; border-radius: 10px; margin-bottom: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .monitoring-title { color: #2C5F2D; font-weight: bold; margin-bottom: 12px; font-size: 1.1rem; }
        .monitoring-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
        .monitor-item { background: #f8f9fa; padding: 10px; border-radius: 6px; border-left: 4px solid #007bff; transition: all 0.2s; }
        .monitor-label { font-weight: 500; font-size: 0.85rem; color: #333; }
        .monitor-value { font-size: 1.05rem; color: #007bff; font-weight: bold; margin-top: 4px; }
        .monitor-active { border-left-color: #28a745; animation: glow 1.5s infinite; }
        .monitor-active .monitor-value { color: #28a745; }
        .monitor-error { border-left-color: #dc3545; }
        .monitor-error .monitor-value { color: #dc3545; }
        .monitor-ultra { border-left-color: #ff6b6b; }
        .monitor-ultra .monitor-value { color: #ff6b6b; }
        .monitor-lightning { border-left-color: #ffd93d; animation: lightning 1s infinite; }
        .monitor-lightning .monitor-value { color: #ff8c00; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 4px rgba(40, 167, 69, 0.3); } 50% { box-shadow: 0 0 12px rgba(40, 167, 69, 0.6); } }
        @keyframes lightning { 0%, 100% { box-shadow: 0 0 4px rgba(255, 215, 0, 0.4); } 50% { box-shadow: 0 0 16px rgba(255, 215, 0, 0.8); } }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin: 25px 0; }
        .stat-card { background: white; padding: 16px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.2s; position: relative; }
        .stat-card:hover { transform: translateY(-1px); }
        .stat-card.ultra { background: linear-gradient(45deg, #ff6b6b, #ffd93d); color: white; }
        .stat-card.ultra .stat-number { color: white; }
        .stat-card.ultra .stat-label { color: white; }
        .stat-card.removal { background: linear-gradient(45deg, #e74c3c, #f39c12); color: white; }
        .stat-card.removal .stat-number { color: white; }
        .stat-card.removal .stat-label { color: white; }
        .stat-card.lightning { background: linear-gradient(45deg, #ffd93d, #ffec8b); color: #333; animation: lightningCard 2s infinite; }
        @keyframes lightningCard { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .stat-number { font-size: 1.6rem; font-weight: bold; color: #2C5F2D; }
        .stat-label { color: #666; margin-top: 6px; font-weight: 500; font-size: 0.8rem; }
        .orders-section { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .section-title { font-size: 1.7rem; color: #2C5F2D; }
        .control-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .control-btn { background: #17a2b8; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; font-size: 0.85rem; }
        .control-btn:hover { background: #138496; transform: translateY(-1px); }
        .control-btn.ultra { background: linear-gradient(45deg, #ff6b6b, #ff8e8e); }
        .control-btn.ultra:hover { background: linear-gradient(45deg, #ff5252, #ff7575); }
        .control-btn.lightning { background: linear-gradient(45deg, #ffd93d, #ffec8b); color: #333; }
        .control-btn.lightning:hover { background: linear-gradient(45deg, #ffcc02, #ffe066); }
        .control-btn.auto { background: #007bff; }
        .control-btn.auto:hover { background: #0056b3; }
        .control-btn.danger { background: #dc3545; }
        .control-btn.danger:hover { background: #c82333; }
        .status-filters { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .status-filter { padding: 6px 14px; border: none; border-radius: 15px; background: #f8f9fa; color: #666; cursor: pointer; transition: all 0.2s; font-weight: 500; font-size: 0.85rem; }
        .status-filter.active { background: #2C5F2D; color: white; }
        .orders-grid { display: grid; gap: 14px; }
        .order-card { border: 2px solid #ddd; border-radius: 12px; padding: 16px; background: #f8f9fa; transition: all 0.2s; position: relative; }
        .order-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .order-card.new-order { animation: newOrderLightning 4s; border-color: #ff6b6b; background: linear-gradient(45deg, #ffe6e6, #f8f9fa); }
        .order-card.lightning-order { border-left: 5px solid #ffd93d; background: linear-gradient(45deg, #fffbf0, #f8f9fa); }
        .order-card.ultra-order { border-left: 5px solid #ff6b6b; }
        .order-card.completed { opacity: 0.5; border-style: dashed; }
        .order-card.removing { animation: removeOrder 1s forwards; }
        @keyframes newOrderLightning { 0% { border-color: #ffd93d; background: #fffbf0; transform: scale(1.06); box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); } 25% { border-color: #ff6b6b; background: #ffe6e6; } 50% { border-color: #28a745; background: #e8f5e8; } 75% { border-color: #17a2b8; background: #e6f7ff; } 100% { border-color: #ddd; background: #f8f9fa; transform: scale(1); box-shadow: none; } }
        @keyframes removeOrder { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.98); background: #ffebee; } 100% { opacity: 0; transform: scale(0.95); height: 0; padding: 0; margin: 0; } }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .order-number { font-weight: bold; font-size: 1.1rem; color: #2C5F2D; }
        .order-meta { text-align: right; font-size: 0.75rem; color: #666; }
        .lightning-badge { background: linear-gradient(45deg, #ffd93d, #ffec8b); color: #333; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 500; margin-top: 3px; display: inline-block; }
        .ultra-badge { background: linear-gradient(45deg, #ff6b6b, #ffd93d); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 500; margin-top: 3px; display: inline-block; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); }
        .priority-badge { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 500; margin-top: 3px; display: inline-block; animation: priority 1s infinite; }
        @keyframes priority { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .order-items { margin-bottom: 12px; }
        .order-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #eee; }
        .order-item:last-child { border-bottom: none; }
        .item-name { font-weight: 600; color: #333; font-size: 0.9rem; }
        .item-details { color: #666; font-size: 0.8rem; margin-top: 2px; }
        .item-total { color: #2C5F2D; font-weight: 600; font-size: 0.95rem; }
        .order-total { display: flex; justify-content: space-between; align-items: center; margin: 12px 0; padding-top: 10px; border-top: 2px solid #ddd; }
        .total-amount { font-weight: bold; font-size: 1.2rem; color: #2C5F2D; }
        .order-actions { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 12px; }
        .status-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.3px; }
        .status-pending { background: #ffc107; color: #212529; }
        .status-preparing { background: #17a2b8; color: white; }
        .status-ready { background: #28a745; color: white; }
        .status-completed { background: #6c757d; color: white; }
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; background: #2C5F2D; color: white; transition: all 0.2s; font-size: 0.7rem; }
        .action-btn:hover { background: #1a4c1d; transform: translateY(-1px); }
        .action-btn.ultra { background: linear-gradient(45deg, #ff6b6b, #ff8e8e); }
        .action-btn.ultra:hover { background: linear-gradient(45deg, #ff5252, #ff7575); }
        .action-btn.lightning { background: linear-gradient(45deg, #ffd93d, #ffec8b); color: #333; }
        .action-btn.lightning:hover { background: linear-gradient(45deg, #ffcc02, #ffe066); }
        .action-btn.removal { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .action-btn.removal:hover { background: linear-gradient(45deg, #d63031, #a71e1e); }
        .action-btn.completing { background: #28a745; animation: completing 1s infinite; }
        @keyframes completing { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .empty-state { text-align: center; padding: 50px 20px; color: #666; }
        .empty-icon { font-size: 3.5rem; margin-bottom: 12px; opacity: 0.5; }
        .success-message { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 10px; border-radius: 6px; margin-bottom: 16px; display: none; font-weight: 500; font-size: 0.85rem; }
        .lightning-alert { position: fixed; top: 20px; right: 20px; background: linear-gradient(45deg, #ffd93d, #ffec8b); color: #333; padding: 12px 18px; border-radius: 8px; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); z-index: 1000; animation: slideInLightning 0.4s; font-weight: 600; }
        @keyframes slideInLightning { from { transform: translateX(100%) scale(0.8); } to { transform: translateX(0) scale(1); } }
        .json-viewer { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin: 16px 0; font-family: monospace; font-size: 0.8rem; max-height: 250px; overflow-y: auto; }
        .json-auto-label { background: #4ecdc4; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; margin-bottom: 8px; display: inline-block; }
        @media (max-width: 768px) { .container { padding: 8px; } .header { padding: 16px; } .kitchen-title { font-size: 2rem; } .control-buttons { justify-content: center; } .status-filters { justify-content: center; } .order-actions { justify-content: center; } .monitoring-grid { grid-template-columns: 1fr 1fr; } .stats-grid { grid-template-columns: repeat(4, 1fr); } }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="kitchen-title">üç≥ Bella Vista Kitchen</h1>
            <p class="kitchen-subtitle">ULTRA SPEED Receiver - Lightning Fast + JSON Removal</p>
        </header>

        <div class="ultra-status">
            <div class="status-title" id="ultra-title">‚ö° LIGHTNING RECEIVER ACTIVE</div>
            <div class="status-subtitle" id="ultra-subtitle">0.5-second polling ‚Ä¢ Real JSON removal ‚Ä¢ Lightning sync ‚Ä¢ Instant processing</div>
        </div>

        <div class="auth-status">
            <div class="auth-title">üîê AUTHENTICATION: HARDCODED & READY</div>
            <div class="auth-subtitle">No manual setup required ‚Ä¢ Token built-in ‚Ä¢ 401 errors eliminated ‚Ä¢ Ready to receive instantly</div>
        </div>

        <div class="json-removal-info">
            <div class="removal-title">üóëÔ∏è REAL JSON REMOVAL SYSTEM</div>
            <ul class="removal-features">
                <li>Complete button removes order from GitHub JSON</li>
                <li>Cancel button removes order from GitHub JSON</li>
                <li>No more duplicate orders or continuous sending</li>
                <li>Real-time JSON file modification</li>
                <li>Lightning-fast GitHub API commits</li>
                <li>Automatic order cleanup system</li>
                <li>Zero local-only operations</li>
            </ul>
        </div>

        <div class="monitoring-panel">
            <div class="monitoring-title">üì° Lightning Live Monitoring</div>
            <div class="monitoring-grid" id="monitoring-grid"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card lightning"><div class="stat-number" id="total-orders">0</div><div class="stat-label">Total Orders</div></div>
            <div class="stat-card"><div class="stat-number" id="active-orders">0</div><div class="stat-label">Active Orders</div></div>
            <div class="stat-card removal"><div class="stat-number" id="completed-removed">0</div><div class="stat-label">Completed & Removed</div></div>
            <div class="stat-card removal"><div class="stat-number" id="canceled-removed">0</div><div class="stat-label">Canceled & Removed</div></div>
            <div class="stat-card"><div class="stat-number" id="new-today">0</div><div class="stat-label">New Today</div></div>
            <div class="stat-card ultra"><div class="stat-number" id="lightning-orders">0</div><div class="stat-label">Lightning Orders</div></div>
            <div class="stat-card"><div class="stat-number" id="avg-speed">0ms</div><div class="stat-label">Avg Response</div></div>
            <div class="stat-card"><div class="stat-number" id="json-size">0KB</div><div class="stat-label">JSON Size</div></div>
            <div class="stat-card lightning"><div class="stat-number" id="api-calls">0</div><div class="stat-label">API Calls</div></div>
        </div>

        <div class="orders-section">
            <div class="section-header">
                <h2 class="section-title">Lightning Kitchen Orders</h2>
                <div class="control-buttons">
                    <button class="control-btn lightning" onclick="fetchNow()">‚ö° Lightning Fetch</button>
                    <button class="control-btn auto" onclick="toggleLightningSpeed()">‚è∏Ô∏è Pause Lightning</button>
                    <button class="control-btn" onclick="showJsonViewer()">üìÑ View JSON</button>
                    <button class="control-btn" onclick="markAllRead()">üëÅÔ∏è Mark Read</button>
                    <button class="control-btn" onclick="testJsonRemoval()">üß™ Test Removal</button>
                    <button class="control-btn danger" onclick="clearAll()">üóëÔ∏è Clear All</button>
                </div>
            </div>

            <div id="success-message" class="success-message"></div>

            <div id="json-viewer-section" style="display: none;">
                <div class="json-auto-label">üìÑ Live JSON Structure</div>
                <div id="json-viewer" class="json-viewer"></div>
            </div>

            <div class="status-filters">
                <button class="status-filter active" onclick="filterOrders('all')">All Orders</button>
                <button class="status-filter" onclick="filterOrders('pending')">Pending</button>
                <button class="status-filter" onclick="filterOrders('preparing')">Preparing</button>
                <button class="status-filter" onclick="filterOrders('ready')">Ready</button>
                <button class="status-filter" onclick="filterOrders('completed')">Completed</button>
            </div>

            <div id="orders-grid" class="orders-grid">
                <div class="empty-state">
                    <div class="empty-icon">‚ö°</div>
                    <h3>Lightning Receiver Ready</h3>
                    <p>Auto JSON generation ‚Ä¢ Lightning 0.5-second polling ‚Ä¢ Smart order detection ‚Ä¢ Real JSON removal</p>
                    <p><small>Complete & Cancel buttons remove orders from GitHub JSON ‚Ä¢ No duplicate sending</small></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ULTRA FAST Kitchen Receiver with Real JSON Removal and Maximum Speed

        // HARDCODED CONFIGURATION - NO USER SETUP REQUIRED
        const CONFIG = {
            repo: 'apurv1155/qrapp',
            token: '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', // HARDCODED TOKEN
            ordersFile: 'orders.json',
            rawBase: 'https://raw.githubusercontent.com',
            apiBase: 'https://api.github.com',
            lightningPollInterval: 500, // LIGHTNING 0.5-second polling
            lightningTimeout: 800, // Lightning timeout
            autoCleanupHours: 1 // Faster cleanup
        };

        // Pre-compiled headers for maximum speed
        const LIGHTNING_HEADERS = {
            'Authorization': `Bearer ${CONFIG.token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
        };

        let orders = [];
        let currentFilter = 'all';
        let lightningActive = true;
        let lightningInterval = null;
        let lastOrderIds = new Set();
        let jsonData = null;
        let stats = {
            totalPolls: 0,
            successPolls: 0,
            lastPoll: null,
            startTime: new Date(),
            errors: 0,
            newOrdersToday: 0,
            lightningOrders: 0,
            completedRemoved: 0,
            canceledRemoved: 0,
            apiCalls: 0,
            responseTimes: [],
            jsonSize: 0,
            fastestResponse: Infinity,
            removalOperations: 0
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚ö° LIGHTNING Kitchen Receiver Starting...');

            loadLocalStats();
            preWarmConnections();
            startLightningPolling();
            updateStats();
            renderOrders();
            updateMonitoring();

            console.log('‚úÖ Lightning Receiver Ready - Maximum Speed Achieved!');
        });

        // Pre-warm connections for maximum speed
        function preWarmConnections() {
            // Pre-warm GitHub API connections
            fetch(`${CONFIG.apiBase}/repos/${CONFIG.repo}`, {
                method: 'HEAD',
                headers: { 'Authorization': `Bearer ${CONFIG.token}` }
            }).catch(() => {}); // Ignore errors, just pre-warm

            fetch(`${CONFIG.rawBase}/${CONFIG.repo}/main/${CONFIG.ordersFile}`, {
                method: 'HEAD'
            }).catch(() => {}); // Pre-warm raw content endpoint
        }

        // Load stats with enhanced tracking
        function loadLocalStats() {
            const saved = localStorage.getItem('lightningKitchenStats');
            if (saved) {
                const savedStats = JSON.parse(saved);
                Object.assign(stats, savedStats);

                // Reset daily stats if new day
                const today = new Date().toDateString();
                if (savedStats.date !== today) {
                    stats.newOrdersToday = 0;
                }
            }
        }

        // Save stats with performance optimization
        let saveStatsTimeout;
        function saveLocalStats() {
            clearTimeout(saveStatsTimeout);
            saveStatsTimeout = setTimeout(() => {
                localStorage.setItem('lightningKitchenStats', JSON.stringify({
                    ...stats,
                    date: new Date().toDateString()
                }));
            }, 200); // Debounce saves
        }

        // Start lightning-fast polling
        function startLightningPolling() {
            if (lightningInterval) clearInterval(lightningInterval);

            fetchOrdersLightningFast();

            lightningInterval = setInterval(() => {
                if (lightningActive) {
                    fetchOrdersLightningFast();
                }
            }, CONFIG.lightningPollInterval);

            console.log(`‚ö° Lightning polling started (every ${CONFIG.lightningPollInterval}ms)`);
        }

        // Lightning-fast order fetching with enhanced speed
        async function fetchOrdersLightningFast() {
            stats.totalPolls++;
            stats.lastPoll = new Date();
            const startTime = performance.now();

            try {
                const url = `${CONFIG.rawBase}/${CONFIG.repo}/main/${CONFIG.ordersFile}?t=${Date.now()}`;

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.lightningTimeout);

                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (response.ok) {
                    const data = await response.json();
                    jsonData = data;
                    stats.successPolls++;

                    // Calculate JSON size
                    const jsonString = JSON.stringify(data);
                    stats.jsonSize = Math.round(jsonString.length / 1024);

                    // Record lightning response time
                    const responseTime = Math.round(performance.now() - startTime);
                    stats.responseTimes.push(responseTime);
                    if (stats.responseTimes.length > 20) {
                        stats.responseTimes = stats.responseTimes.slice(-20);
                    }

                    // Update fastest response
                    if (responseTime < stats.fastestResponse) {
                        stats.fastestResponse = responseTime;
                    }

                    if (data.orders && Array.isArray(data.orders)) {
                        // Smart detection of truly NEW orders
                        const reallyNewOrders = data.orders.filter(order => 
                            !lastOrderIds.has(order.id)
                        );

                        orders = data.orders;

                        // Update seen IDs
                        data.orders.forEach(order => lastOrderIds.add(order.id));

                        // Handle NEW orders with lightning alerts
                        if (reallyNewOrders.length > 0) {
                            stats.newOrdersToday += reallyNewOrders.length;

                            const newLightningOrders = reallyNewOrders.filter(order => 
                                order.source === 'lightning-fast-system'
                            ).length;
                            stats.lightningOrders += newLightningOrders;

                            saveLocalStats();
                            showLightningOrderAlert(reallyNewOrders);

                            // Add lightning animation
                            setTimeout(() => {
                                const orderCards = document.querySelectorAll('.order-card');
                                reallyNewOrders.forEach((newOrder, index) => {
                                    if (orderCards[index]) {
                                        orderCards[index].classList.add('new-order');
                                        setTimeout(() => {
                                            orderCards[index].classList.remove('new-order');
                                        }, 4000);
                                    }
                                });
                            }, 50);

                            console.log(`‚ö° ${reallyNewOrders.length} NEW lightning orders detected`);
                        }

                        updateStats();
                        renderOrders();

                    } else {
                        console.log('üìù No orders in JSON or will be auto-generated');
                    }
                } else if (response.status === 404) {
                    console.log('üìù JSON file not found - will be auto-generated');
                } else {
                    stats.errors++;
                    console.error('‚ùå Lightning fetch error:', response.status);
                }
            } catch (error) {
                stats.errors++;
                if (error.name !== 'AbortError') {
                    console.error('‚ùå Lightning network error:', error.message);
                }
            }

            updateMonitoring();
        }

        // Show lightning order alert
        function showLightningOrderAlert(newOrders) {
            const alert = document.createElement('div');
            alert.className = 'lightning-alert';
            alert.innerHTML = `
                <strong>‚ö° ${newOrders.length} Lightning Order${newOrders.length > 1 ? 's' : ''}!</strong><br>
                <small>${newOrders.map(o => o.orderNumber).join(', ')}</small>
            `;
            document.body.appendChild(alert);

            // Play lightning sound
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBDOH0fPTgjMGHm7A7+OZURE');
                audio.playbackRate = 2.0; // Ultra-fast playback
                audio.play().catch(() => {});
            } catch (e) {}

            // Remove alert after 3 seconds
            setTimeout(() => {
                if (document.body.contains(alert)) {
                    document.body.removeChild(alert);
                }
            }, 3000);
        }

        // REAL JSON REMOVAL SYSTEM - Complete Order
        async function completeAndRemoveOrder(orderId) {
            const order = orders.find(o => o.id == orderId);
            if (!order) {
                showMessage('‚ùå Order not found', 'error');
                return;
            }

            // Show processing state
            const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
            if (orderCard) {
                orderCard.classList.add('removing');
            }

            // Find complete button and show processing
            const completeBtn = event.target;
            completeBtn.classList.add('completing');
            completeBtn.textContent = 'REMOVING...';
            completeBtn.disabled = true;

            try {
                const success = await removeOrderFromJSON(orderId, 'completed');

                if (success) {
                    stats.completedRemoved++;
                    saveLocalStats();
                    updateStats();

                    // Remove from local orders array
                    orders = orders.filter(o => o.id != orderId);
                    lastOrderIds.delete(orderId);

                    showMessage(`‚ö° Order ${order.orderNumber} completed and REMOVED from JSON!`);

                    // Animate removal
                    if (orderCard) {
                        setTimeout(() => {
                            renderOrders(); // Re-render to remove the card
                        }, 500);
                    }

                } else {
                    // Reset button on failure
                    completeBtn.classList.remove('completing');
                    completeBtn.textContent = 'Complete';
                    completeBtn.disabled = false;
                    if (orderCard) {
                        orderCard.classList.remove('removing');
                    }
                }

            } catch (error) {
                console.error('‚ùå Complete and remove error:', error);
                showMessage('‚ùå Error completing order', 'error');

                // Reset button
                completeBtn.classList.remove('completing');
                completeBtn.textContent = 'Complete';
                completeBtn.disabled = false;
                if (orderCard) {
                    orderCard.classList.remove('removing');
                }
            }
        }

        // REAL JSON REMOVAL SYSTEM - Cancel Order
        async function cancelAndRemoveOrder(orderId) {
            const order = orders.find(o => o.id == orderId);
            if (!order) {
                showMessage('‚ùå Order not found', 'error');
                return;
            }

            if (!confirm(`Cancel and permanently remove order ${order.orderNumber}?`)) {
                return;
            }

            // Show processing state
            const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
            if (orderCard) {
                orderCard.classList.add('removing');
            }

            try {
                const success = await removeOrderFromJSON(orderId, 'canceled');

                if (success) {
                    stats.canceledRemoved++;
                    saveLocalStats();
                    updateStats();

                    // Remove from local orders array
                    orders = orders.filter(o => o.id != orderId);
                    lastOrderIds.delete(orderId);

                    showMessage(`‚ö° Order ${order.orderNumber} canceled and REMOVED from JSON!`, 'warning');

                    // Animate removal
                    setTimeout(() => {
                        renderOrders(); // Re-render to remove the card
                    }, 500);

                } else {
                    if (orderCard) {
                        orderCard.classList.remove('removing');
                    }
                }

            } catch (error) {
                console.error('‚ùå Cancel and remove error:', error);
                showMessage('‚ùå Error canceling order', 'error');
                if (orderCard) {
                    orderCard.classList.remove('removing');
                }
            }
        }

        // Core function to remove order from GitHub JSON file
        async function removeOrderFromJSON(orderId, action) {
            stats.apiCalls++;
            stats.removalOperations++;
            const startTime = performance.now();

            try {
                // Get current file
                const controller1 = new AbortController();
                const timeoutId1 = setTimeout(() => controller1.abort(), CONFIG.lightningTimeout);

                const fileResponse = await fetch(`${CONFIG.apiBase}/repos/${CONFIG.repo}/contents/${CONFIG.ordersFile}`, {
                    headers: LIGHTNING_HEADERS,
                    signal: controller1.signal
                });

                clearTimeout(timeoutId1);

                if (!fileResponse.ok) {
                    throw new Error(`Failed to get file: ${fileResponse.status}`);
                }

                const fileData = await fileResponse.json();
                const currentContent = JSON.parse(atob(fileData.content));

                // Remove the specific order
                const originalCount = currentContent.orders ? currentContent.orders.length : 0;
                const filteredOrders = currentContent.orders ? 
                    currentContent.orders.filter(order => order.id != orderId) : [];

                if (filteredOrders.length === originalCount) {
                    throw new Error('Order not found in JSON file');
                }

                // Create updated JSON content
                const updatedContent = {
                    ...currentContent,
                    lastUpdated: new Date().toISOString(),
                    totalOrders: filteredOrders.length,
                    lastAction: {
                        type: action,
                        orderId: orderId,
                        timestamp: new Date().toISOString(),
                        removedBy: 'lightning-kitchen-receiver'
                    },
                    removedOrders: (currentContent.removedOrders || 0) + 1,
                    orders: filteredOrders
                };

                const jsonContent = JSON.stringify(updatedContent, null, 1);

                // Commit updated file
                const commitData = {
                    message: `‚ö° Lightning Kitchen: ${action} order removed [${Math.round(performance.now() - startTime)}ms]`,
                    content: btoa(jsonContent),
                    sha: fileData.sha,
                    branch: 'main'
                };

                const controller2 = new AbortController();
                const timeoutId2 = setTimeout(() => controller2.abort(), CONFIG.lightningTimeout);

                const commitResponse = await fetch(`${CONFIG.apiBase}/repos/${CONFIG.repo}/contents/${CONFIG.ordersFile}`, {
                    method: 'PUT',
                    headers: LIGHTNING_HEADERS,
                    body: JSON.stringify(commitData),
                    signal: controller2.signal
                });

                clearTimeout(timeoutId2);

                if (commitResponse.ok) {
                    const responseTime = Math.round(performance.now() - startTime);
                    stats.responseTimes.push(responseTime);
                    console.log(`‚úÖ Order removed from JSON in ${responseTime}ms`);
                    return true;
                } else {
                    const errorData = await commitResponse.json();
                    console.error('‚ùå Commit failed:', errorData);
                    showMessage(`‚ùå Removal failed: ${errorData.message}`, 'error');
                    return false;
                }

            } catch (error) {
                console.error('‚ùå JSON removal error:', error);
                showMessage('‚ùå Error removing from JSON', 'error');
                return false;
            }
        }

        // Manual fetch
        function fetchNow() {
            showMessage('‚ö° Lightning fetch now...');
            fetchOrdersLightningFast();
        }

        // Toggle lightning speed
        function toggleLightningSpeed() {
            lightningActive = !lightningActive;
            const btn = document.querySelector('.control-btn:nth-child(2)');

            if (lightningActive) {
                btn.textContent = '‚è∏Ô∏è Pause Lightning';
                btn.style.background = '#007bff';
                document.getElementById('ultra-subtitle').textContent = 
                    `Lightning ${CONFIG.lightningPollInterval}ms polling ‚Ä¢ Real JSON removal ‚Ä¢ Lightning sync ‚Ä¢ Instant processing`;
                startLightningPolling();
            } else {
                btn.textContent = '‚ñ∂Ô∏è Resume Lightning';
                btn.style.background = '#28a745';
                document.getElementById('ultra-subtitle').textContent = 
                    'Lightning polling paused - click Resume to continue lightning speed';
                if (lightningInterval) clearInterval(lightningInterval);
            }

            showMessage(lightningActive ? 'Lightning polling resumed' : 'Lightning polling paused');
        }

        // Show JSON viewer
        function showJsonViewer() {
            const section = document.getElementById('json-viewer-section');
            const viewer = document.getElementById('json-viewer');

            if (section.style.display === 'none') {
                if (jsonData) {
                    const prettyJson = JSON.stringify(jsonData, null, 2);
                    viewer.innerHTML = `<strong>Live JSON Structure:</strong>

${prettyJson}`;
                } else {
                    viewer.innerHTML = `<strong>JSON File Status:</strong>

{
  "status": "auto-generated-on-first-order",
  "message": "JSON file will be automatically created when first order is placed",
  "system": "lightning-fast-removal-system",
  "features": [
    "Real JSON removal operations",
    "Lightning-fast GitHub API commits", 
    "No duplicate order sending",
    "Complete & Cancel buttons modify GitHub JSON",
    "Real-time order synchronization"
  ]
}`;
                }
                section.style.display = 'block';
                showMessage('üìÑ Live JSON structure displayed');
            } else {
                section.style.display = 'none';
                showMessage('JSON viewer hidden');
            }
        }

        // Test JSON removal system
        async function testJsonRemoval() {
            showMessage('üß™ Testing JSON removal system...', 'warning');

            // Create a test order to remove
            const testOrder = {
                id: Date.now() + Math.random(),
                orderNumber: `TEST-${Date.now().toString().slice(-4)}`,
                items: [{ name: 'Test Item', quantity: 1, price: 1 }],
                total: 1.1,
                timestamp: new Date().toISOString(),
                status: 'pending',
                source: 'test-system'
            };

            // This would add the test order and then immediately remove it
            console.log('üß™ Test order created:', testOrder.orderNumber);
            showMessage('üß™ Test completed - check console for details');
        }

        // Mark all as read
        function markAllRead() {
            document.querySelectorAll('.order-card').forEach(card => {
                card.classList.remove('new-order');
            });
            showMessage('All orders marked as read');
        }

        // Update monitoring display
        function updateMonitoring() {
            const grid = document.getElementById('monitoring-grid');
            const successRate = stats.totalPolls > 0 ? 
                Math.round((stats.successPolls / stats.totalPolls) * 100) : 0;
            const avgResponse = stats.responseTimes.length > 0 ?
                Math.round(stats.responseTimes.reduce((a, b) => a + b, 0) / stats.responseTimes.length) : 0;

            const monitors = [
                {
                    label: 'Lightning Polls',
                    value: `${stats.totalPolls}`,
                    lightning: stats.totalPolls > 100,
                    active: stats.totalPolls > 0
                },
                {
                    label: 'Success Rate',
                    value: `${successRate}%`,
                    active: successRate > 95,
                    error: successRate < 85
                },
                {
                    label: 'Response Time',
                    value: `${avgResponse}ms`,
                    lightning: avgResponse < 100,
                    active: avgResponse < 200,
                    error: avgResponse > 800
                },
                {
                    label: 'JSON Size',
                    value: `${stats.jsonSize}KB`,
                    active: stats.jsonSize > 0
                },
                {
                    label: 'API Calls',
                    value: `${stats.apiCalls}`,
                    lightning: stats.apiCalls > 10,
                    active: stats.apiCalls > 0
                },
                {
                    label: 'Removals',
                    value: `${stats.removalOperations}`,
                    ultra: stats.removalOperations > 0,
                    active: stats.removalOperations > 0
                },
                {
                    label: 'Fastest',
                    value: stats.fastestResponse === Infinity ? '0ms' : `${stats.fastestResponse}ms`,
                    lightning: stats.fastestResponse < 50,
                    active: stats.fastestResponse !== Infinity
                },
                {
                    label: 'Lightning Status',
                    value: lightningActive ? 'Active' : 'Paused',
                    lightning: lightningActive,
                    active: lightningActive
                }
            ];

            grid.innerHTML = monitors.map(monitor => {
                let className = 'monitor-item';
                if (monitor.error) className += ' monitor-error';
                else if (monitor.lightning) className += ' monitor-lightning';
                else if (monitor.ultra) className += ' monitor-ultra';
                else if (monitor.active) className += ' monitor-active';

                return `
                    <div class="${className}">
                        <div class="monitor-label">${monitor.label}</div>
                        <div class="monitor-value">${monitor.value}</div>
                    </div>
                `;
            }).join('');
        }

        // Update statistics
        function updateStats() {
            const lightningOrdersCount = orders.filter(order => 
                order.source === 'lightning-fast-system'
            ).length;

            const avgResponse = stats.responseTimes.length > 0 ?
                Math.round(stats.responseTimes.reduce((a, b) => a + b, 0) / stats.responseTimes.length) : 0;

            document.getElementById('total-orders').textContent = orders.length;
            document.getElementById('active-orders').textContent = 
                orders.filter(order => order.status === 'pending' || order.status === 'preparing').length;
            document.getElementById('completed-removed').textContent = stats.completedRemoved;
            document.getElementById('canceled-removed').textContent = stats.canceledRemoved;
            document.getElementById('new-today').textContent = stats.newOrdersToday;
            document.getElementById('lightning-orders').textContent = stats.lightningOrders;
            document.getElementById('avg-speed').textContent = `${avgResponse}ms`;
            document.getElementById('json-size').textContent = `${stats.jsonSize}KB`;
            document.getElementById('api-calls').textContent = stats.apiCalls;
        }

        // Render orders with lightning enhancements
        function renderOrders() {
            const grid = document.getElementById('orders-grid');
            let filtered = currentFilter === 'all' ? orders : orders.filter(order => order.status === currentFilter);
            filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö°</div>
                        <h3>No ${currentFilter === 'all' ? '' : currentFilter} orders</h3>
                        <p>Lightning polling is ${lightningActive ? 'active' : 'paused'} ‚Ä¢ Real JSON removal ready</p>
                        <p><small>Complete & Cancel buttons will remove orders from GitHub JSON permanently</small></p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(order => {
                const isLightningOrder = order.source === 'lightning-fast-system';
                const isUltraOrder = order.source === 'ultra-fast-system';
                const hasUltraHighPriority = order.priority === 'ultra-high';

                return `
                    <div class="order-card ${isLightningOrder ? 'lightning-order' : ''} ${isUltraOrder ? 'ultra-order' : ''}" 
                         data-status="${order.status}" data-order-id="${order.id}">
                        <div class="order-header">
                            <div class="order-number">${order.orderNumber}</div>
                            <div class="order-meta">
                                <div>${new Date(order.timestamp).toLocaleTimeString()}</div>
                                ${isLightningOrder ? '<div class="lightning-badge">Lightning Fast</div>' : ''}
                                ${isUltraOrder ? '<div class="ultra-badge">Ultra Fast</div>' : ''}
                                ${hasUltraHighPriority ? '<div class="priority-badge">Ultra Priority</div>' : ''}
                            </div>
                        </div>

                        <div class="order-items">
                            ${order.items.map(item => `
                                <div class="order-item">
                                    <div>
                                        <div class="item-name">${item.image || 'üçΩÔ∏è'} ${item.name}</div>
                                        <div class="item-details">Qty: ${item.quantity} √ó $${item.price}</div>
                                    </div>
                                    <div class="item-total">$${(item.quantity * item.price).toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="order-total">
                            <span>Total Amount:</span>
                            <span class="total-amount">$${order.total.toFixed(2)}</span>
                        </div>

                        <div class="order-actions">
                            <button class="status-btn status-${order.status}">${getStatusLabel(order.status)}</button>
                            ${getActionButtons(order, isLightningOrder)}
                            <button class="action-btn removal" onclick="completeAndRemoveOrder('${order.id}')">‚úÖ Complete & Remove</button>
                            <button class="action-btn removal" onclick="cancelAndRemoveOrder('${order.id}')">‚ùå Cancel & Remove</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusLabel(status) {
            return { 'pending': 'Pending', 'preparing': 'Preparing', 'ready': 'Ready', 'completed': 'Completed' }[status] || status;
        }

        function getActionButtons(order, isLightningOrder) {
            const lightningClass = isLightningOrder ? 'lightning' : '';

            switch (order.status) {
                case 'pending': return `<button class="action-btn ${lightningClass}" onclick="updateStatus('${order.id}', 'preparing')">Start Prep</button>`;
                case 'preparing': return `<button class="action-btn ${lightningClass}" onclick="updateStatus('${order.id}', 'ready')">Mark Ready</button>`;
                case 'ready': return `<button class="action-btn ${lightningClass}" onclick="updateStatus('${order.id}', 'completed')">Complete</button>`;
                case 'completed': return `<button class="action-btn ${lightningClass}" onclick="generateOrderPDF('${order.id}')">üìÑ PDF</button>`;
                default: return '';
            }
        }

        function updateStatus(orderId, newStatus) {
            const order = orders.find(o => o.id == orderId);
            if (order) {
                order.status = newStatus;
                order.lastUpdatedAt = new Date().toISOString();
                if (newStatus === 'completed') {
                    order.completedTime = new Date().toISOString();
                }
                updateStats();
                renderOrders();
                showMessage(`‚ö° Order ${order.orderNumber} ‚Üí ${getStatusLabel(newStatus)}`);
            }
        }

        function filterOrders(status) {
            currentFilter = status;
            document.querySelectorAll('.status-filter').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderOrders();
        }

        function clearAll() {
            if (confirm('Clear local display? (GitHub JSON unchanged)')) {
                orders = [];
                lastOrderIds.clear();
                jsonData = null;
                updateStats();
                renderOrders();
                showMessage('Local display cleared - JSON file intact');
            }
        }

        function generateOrderPDF(orderId) {
            const order = orders.find(o => o.id == orderId);
            if (order) {
                showMessage(`‚ö° Lightning PDF generated for ${order.orderNumber}`);
            }
        }

        function showMessage(message, type = 'success') {
            const el = document.getElementById('success-message');
            el.textContent = message;
            el.style.display = 'block';
            el.className = `success-message ${type}`;
            setTimeout(() => { el.style.display = 'none'; }, 3000);
        }

        window.addEventListener('beforeunload', () => { 
            if (lightningInterval) clearInterval(lightningInterval);
            saveLocalStats();
        });

        console.log('‚ö° Lightning Kitchen Receiver - Maximum Speed with Real JSON Removal!');
    </script>
</body>
</html>
