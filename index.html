<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bella Vista Restaurant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: #f0f4f8;
        }
        .message {
            display: none;
            transition: all 0.3s ease;
        }
        .message.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .message.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .btn-primary {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .menu-item:hover .item-card {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        .menu-item:hover .item-name {
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <!-- Main Container -->
    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg mt-8 max-w-7xl">
        <header class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-blue-600 tracking-tight">Bella Vista Restaurant</h1>
            <p class="mt-2 text-xl text-gray-600">Your order, just a click away.</p>
        </header>

        <!-- Message Box -->
        <div id="message" class="message rounded-lg p-4 text-center mb-6 font-semibold"></div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Menu Section -->
            <section class="lg:col-span-2 p-6 bg-gray-50 rounded-lg shadow-inner">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Menu</h2>
                <div id="menu-items" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Menu items will be dynamically generated here -->
                </div>
            </section>

            <!-- Order Section -->
            <aside class="lg:col-span-1 p-6 bg-white rounded-lg shadow-md flex flex-col h-full">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Cart</h2>
                <div id="cart" class="flex-grow overflow-y-auto mb-6 pr-2">
                    <!-- Cart items will be dynamically generated here -->
                </div>
                <div id="cart-summary" class="border-t pt-4 text-lg font-semibold text-gray-700">
                    <p>Total: <span id="total-price" class="text-blue-600">‚Çπ0.00</span></p>
                </div>
                <button id="send-order-btn" class="btn-primary w-full mt-6 bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400">
                    üöÄ SEND ORDER TO KITCHEN
                </button>
            </aside>
        </div>
    </div>

    <script>
        // GitHub API configuration. Replace with your actual repo and file name.
        const CONFIG = {
            repo: 'apurv1155/qrapp',
            file: 'orders.json',
            // WARNING: Do not share this token. It is for demonstration purposes only.
            token: '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'
        };

        const MENU = [
            { name: 'Margherita Pizza', price: 250, id: 'pizza-margherita' },
            { name: 'Pasta Arrabiata', price: 300, id: 'pasta-arrabiata' },
            { name: 'Caesar Salad', price: 180, id: 'caesar-salad' },
            { name: 'Mushroom Risotto', price: 350, id: 'mushroom-risotto' },
            { name: 'Tiramisu', price: 150, id: 'tiramisu' },
            { name: 'Coke', price: 50, id: 'coke' },
            { name: 'Cheeseburger', price: 280, id: 'cheeseburger' },
            { name: 'French Fries', price: 100, id: 'french-fries' },
        ];

        let cart = {};
        let orderNumber = 1;

        const menuItemsEl = document.getElementById('menu-items');
        const cartEl = document.getElementById('cart');
        const totalPriceEl = document.getElementById('total-price');
        const sendBtn = document.getElementById('send-order-btn');

        // Render menu items on page load
        function renderMenu() {
            menuItemsEl.innerHTML = MENU.map(item => `
                <div class="menu-item cursor-pointer p-4 bg-white rounded-xl shadow-md transform transition-transform" onclick="addToCart('${item.id}', '${item.name}', ${item.price})">
                    <div class="item-card text-center">
                        <h3 class="item-name text-lg font-semibold text-gray-800 transition-colors">${item.name}</h3>
                        <p class="item-price text-gray-600">‚Çπ${item.price}</p>
                    </div>
                </div>
            `).join('');
        }

        // Add item to cart
        function addToCart(id, name, price) {
            if (cart[id]) {
                cart[id].quantity++;
            } else {
                cart[id] = { name, price, quantity: 1 };
            }
            updateCart();
            showMessage(`Added ${name} to cart`, 'success');
        }

        // Update the cart display
        function updateCart() {
            let total = 0;
            cartEl.innerHTML = '';
            for (const id in cart) {
                const item = cart[id];
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                cartEl.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg mb-2 shadow-sm">
                        <span class="font-medium text-gray-700">${item.name} x ${item.quantity}</span>
                        <span class="text-blue-600 font-semibold">‚Çπ${itemTotal}</span>
                        <button onclick="removeFromCart('${id}')" class="text-red-500 hover:text-red-700 focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
            }
            totalPriceEl.textContent = `‚Çπ${total}`;
            sendBtn.disabled = Object.keys(cart).length === 0;
        }

        // Remove item from cart
        function removeFromCart(id) {
            delete cart[id];
            updateCart();
            showMessage('Item removed from cart', 'success');
        }

        // Show a temporary message
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type} rounded-lg p-4 text-center mb-6 font-semibold shadow-md animate-fade-in-down`;
            msg.style.display = 'block';
            setTimeout(() => { msg.style.display = 'none'; }, 4000);
        }

        // Send order to GitHub
        sendBtn.addEventListener('click', sendOrderToGitHub);

        async function sendOrderToGitHub() {
            if (Object.keys(cart).length === 0) {
                showMessage('Cart is empty!', 'error');
                return;
            }

            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            const order = {
                orderNumber: orderNumber++,
                items: cart,
                timestamp: new Date().toISOString()
            };

            try {
                // Step 1: Get the current file content to check for existence and get the SHA
                const getResponse = await fetch(`https://api.github.com/repos/${CONFIG.repo}/contents/${CONFIG.file}`, {
                    headers: {
                        'Authorization': `Bearer ${CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                let existingContent = [];
                let sha = null;

                if (getResponse.status === 200) {
                    const data = await getResponse.json();
                    sha = data.sha;
                    const decodedContent = atob(data.content.replace(/\s/g, ''));
                    try {
                        existingContent = JSON.parse(decodedContent);
                    } catch (e) {
                        console.error('Error parsing JSON:', e);
                        showMessage('‚ùå Failed to parse existing orders file', 'error');
                        sendBtn.disabled = false;
                        return;
                    }
                } else if (getResponse.status !== 404) {
                    // If it's not a 404, it's a real error.
                    const error = await getResponse.json();
                    showMessage(`‚ùå Failed to read existing orders: ${error.message}`, 'error');
                    sendBtn.disabled = false;
                    return;
                }
                
                // Step 2: Append the new order and encode the content
                existingContent.push(order);
                const newContent = JSON.stringify(existingContent, null, 2);
                const encodedContent = btoa(newContent);

                const commitData = {
                    message: `New order #${order.orderNumber}`,
                    content: encodedContent
                };

                // Add SHA to the commit data only if the file already existed
                if (sha) {
                    commitData.sha = sha;
                }

                // Step 3: Send the PUT request to create or update the file
                const putResponse = await fetch(`https://api.github.com/repos/${CONFIG.repo}/contents/${CONFIG.file}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(commitData)
                });

                if (putResponse.ok) {
                    showMessage(`‚úÖ Order ${order.orderNumber} sent to kitchen successfully!`, 'success');
                    cart = {};
                    updateCart();
                } else {
                    const error = await putResponse.json();
                    showMessage(`‚ùå Failed to send order: ${error.message}`, 'error');
                }

            } catch (error) {
                console.error('Network or other error:', error);
                showMessage('‚ùå Network error or failed to send - please try again', 'error');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'üöÄ SEND ORDER TO KITCHEN';
            }
        }

        // Initialize the app
        renderMenu();
        updateCart();
    </script>
</body>
</html>
